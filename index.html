<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Warrior Quiz Arena</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { box-sizing: border-box; }
    .warrior-bg { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%); }
    .ancient-pattern { background-image: radial-gradient(circle at 25% 25%, rgba(255, 215, 0, 0.1) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(255, 69, 0, 0.1) 0%, transparent 50%); }
    .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
    .confetti { position: fixed; top: -10px; width: 8px; height: 14px; opacity: .9; transform: rotate(15deg); pointer-events:none; }
    @keyframes fall { to { transform: translateY(110vh) rotate(360deg); opacity: 1; } }
    .rank-jump { animation: rankJump .6s ease-out; }
    @keyframes rankJump { 0%{transform: translateY(0)} 30%{transform: translateY(-14px)} 100%{transform: translateY(0)} }
    .modal-bg { background: rgba(0,0,0,.6); }
    .ff-table th, .ff-table td { white-space: nowrap; }
    .ff-cell { min-width: 64px; text-align: center; }
    .ff-badge { padding: 0.15rem 0.4rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; display:inline-block; }

    /* Smooth slow spin without heavy motion (NEW) */
    @keyframes spin-slow { to { transform: rotate(360deg); } }
    .animate-spin-slow { animation: spin-slow 2s linear infinite; }
  </style>
</head>
<body class="warrior-bg ancient-pattern min-h-screen">

<!-- LOGIN -->
<div id="loginScreen" class="min-h-screen p-4 flex items-start justify-center">
  <div class="w-full max-w-xl">
    <div class="bg-gradient-to-br from-amber-100 to-orange-100 rounded-3xl shadow-2xl p-8 w-full border-4 border-amber-600">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">⚔️</div>
        <h1 class="text-3xl font-bold text-amber-900 mb-2">Warrior Quiz Arena</h1>
        <p class="text-amber-700">Enter the Ancient Battle</p>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-amber-800 font-semibold mb-2">Username</label>
          <input type="text" id="username" class="w-full px-4 py-3 rounded-xl border-2 border-amber-300 focus:border-amber-600 focus:outline-none" placeholder="Enter username"/>
        </div>
        <div>
          <label class="block text-amber-800 font-semibold mb-2">Password</label>
          <input type="password" id="password" class="w-full px-4 py-3 rounded-xl border-2 border-amber-300 focus:border-amber-600 focus:outline-none" placeholder="Enter password"/>
        </div>
        <div class="flex space-x-4">
          <button onclick="login('admin')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">🛡️ Admin</button>
          <button onclick="login('participant')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">⚔️ Warrior</button>
        </div>
        <button onclick="openLeaderboardModal()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300">🏆 View Leaderboard</button>
      </div>
      <div class="mt-6 text-sm text-amber-700 bg-amber-50 p-4 rounded-xl">
        <p><strong>Warriors:</strong> warrior1-8 / battle123</p>
      </div>
    </div>
  </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboardModal" class="hidden fixed inset-0 z-50 modal-bg flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold text-gray-800">🏆 Live Leaderboard</h2>
      <button onclick="closeLeaderboardModal()" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">✖</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div id="loginLeaderboard" class="space-y-2 overflow-y-auto max-h-[500px]"></div>
      <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
        <canvas id="leaderboardChart" height="420"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminDashboard" class="hidden min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <div class="bg-gradient-to-r from-red-800 to-red-600 rounded-2xl p-6 mb-6 text-white">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">🛡️ Admin Command Center</h1>
          <p class="text-red-200">Build sets, add images by URL, run them.</p>
        </div>
        <button onclick="logout()" class="bg-red-900 hover:bg-red-800 px-4 py-2 rounded-lg transition-colors">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- SET BUILDER -->
      <div class="bg-white rounded-2xl shadow-xl p-6 lg:col-span-2">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">🧰 Question Set Builder</h2>

        <div class="grid md:grid-cols-3 gap-3 mb-4">
          <input id="setName" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none md:col-span-2" placeholder="Set name"/>
          <button onclick="createFreshSet()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 rounded-lg">➕ New Set (7)</button>
        </div>
        <div class="grid md:grid-cols-3 gap-3 mb-4">
          <select id="savedSets" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"></select>
          <button onclick="loadSelectedSet()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">📥 Load</button>
          <button onclick="saveCurrentSet()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg">💾 Save</button>
        </div>

        <div id="setQuestions" class="space-y-4"></div>

        <div class="flex flex-wrap gap-2 mt-4">
          <button onclick="addQuestionRow()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-3 rounded-lg">➕ Add Question</button>
          <button onclick="startSetRun()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg">🏁 Start Set</button>
          <button onclick="cancelSetRun()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 font-bold py-2 px-3 rounded-lg">⏹ Stop</button>
          <span id="setRunStatus" class="ml-2 text-sm text-gray-600"></span>
        </div>
        <p id="imageTip" class="mt-3 text-xs text-amber-700">
          Tip: Paste a <em>direct</em> image URL ending in .png, .jpg, .jpeg, .gif, or .webp. Links like <code>https://ibb.co/…</code> are pages, not image files.
        </p>
      </div>

      <!-- LIVE STATS + ADMIN LB + RESET -->
      <div class="space-y-6">
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">⚡ Battle Statistics</h2>
          <div class="space-y-4">
            <div class="bg-green-50 p-4 rounded-xl">
              <h3 class="font-bold text-green-800 mb-2">⚡ Fastest Finger (Current Question)</h3>
              <div id="fastestFinger" class="text-green-600">Waiting for answers...</div>
            </div>
            <div class="bg-blue-50 p-4 rounded-xl">
              <h3 class="font-bold text-blue-800 mb-2">👥 Active Warriors</h3>
              <div id="activeParticipants" class="text-blue-600">0 warriors online</div>
            </div>
            <div class="bg-purple-50 p-4 rounded-xl">
              <h3 class="font-bold text-purple-800 mb-2">📊 Current Question</h3>
              <div id="currentQuestionStatus" class="text-purple-600">No active question</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">🧮 Points & Participants</h2>
          <div class="space-y-3">
            <select id="adminSelectUser" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"></select>
            <input id="adminDelta" type="number" placeholder="Points (+ or -)" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
            <input id="adminReason" type="text" placeholder="Reason" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
            <div class="flex gap-2">
              <button onclick="adminAddPoints()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg">➕/➖ Adjust</button>
              <button onclick="adminRemoveParticipant(true)" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">🗑️ Remove</button>
              <button onclick="adminRemoveParticipant(false)" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">♻️ Restore</button>
            </div>
            <button onclick="resetGame()" class="w-full bg-red-800 hover:bg-red-900 text-white font-bold py-2 rounded-lg mt-3">♻️ Reset Game</button>
            <div id="adminActionMsg" class="text-sm text-gray-600"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN LEADERBOARD -->
    <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">🏆 Warrior Leaderboard</h2>
      <div id="adminLeaderboard" class="space-y-2"></div>
    </div>

    <!-- ⏱️ FASTEST FINGER LOG (PERSISTENT) -->
    <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">⏱️ Fastest Finger Log (All Questions)</h2>
        <button id="ffRefreshBtn" class="text-sm px-3 py-1 rounded bg-gray-100 hover:bg-gray-200" onclick="refreshFastestHistory()">Refresh</button>
      </div>
      <div class="overflow-auto">
        <table class="ff-table min-w-full text-sm">
          <thead id="ffHead"></thead>
          <tbody id="ffBody"></tbody>
        </table>
      </div>
      <div id="ffMsg" class="text-sm text-gray-600 mt-2"></div>
    </div>

    <!-- ==== PHOTO SHARING: Admin Control + Inbox ==== -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Control -->
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">📸 Photo Sharing Control</h2>

        <label class="flex items-center gap-3 mb-3">
          <input id="allowPhotoShare" type="checkbox" class="w-5 h-5" onchange="onAdminTogglePhotoShare(this.checked)" />
          <span class="text-gray-800 font-semibold">Allow participants to share photos</span>
        </label>

        <div id="photoDurationRow" class="flex items-center gap-3 mb-2">
          <label class="text-sm text-gray-700">Auto stop after</label>
          <select id="photoDuration" class="px-2 py-1 border rounded-lg">
            <option value="1">1 min</option>
            <option value="3" selected>3 min</option>
            <option value="5">5 min</option>
            <option value="10">10 min</option>
            <option value="0">No auto stop</option>
          </select>
        </div>

        <div class="text-sm text-gray-600 mt-1" id="photoToggleMsg"></div>
        <div class="text-sm text-amber-700 mt-1" id="photoCountdown"></div>

        <!-- ✅ NEW: Admin-side Fastest Finger (Live) list -->
        <div class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-amber-800">⚡ Fastest Finger (Live)</h3>
            <button class="text-xs px-2 py-1 bg-amber-200 rounded hover:bg-amber-300" onclick="updatePhotoFastest()">Refresh</button>
          </div>
          <div id="photoFastestListAdmin" class="mt-3 text-amber-900 text-sm">Waiting for answers...</div>
        </div>
        <!-- /NEW -->
      </div>

      <!-- Inbox -->
      <div class="bg-white rounded-2xl shadow-xl p-6 lg:col-span-2">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-800">🗃️ Photo Inbox <span id="photoCount" class="text-gray-500 text-lg"></span></h2>
          <button onclick="refreshPhotoInbox()" class="bg-gray-800 hover:bg-gray-900 text-white text-sm px-3 py-2 rounded-lg">Refresh</button>
        </div>
        <div id="photoInbox" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
        <div id="photoInboxMsg" class="text-sm text-gray-600 mt-3"></div>
      </div>
    </div>
    <!-- ==== /PHOTO SHARING ==== -->
  </div>
</div>

<!-- PARTICIPANT -->
<div id="participantDashboard" class="hidden min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <div class="bg-gradient-to-r from-blue-800 to-blue-600 rounded-2xl p-6 mb-6 text-white">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <div id="participantAvatar" class="text-4xl"></div>
          <div>
            <h1 class="text-2xl font-bold" id="participantName">Warrior</h1>
            <p class="text-blue-200">Ready for Battle</p>
          </div>
        </div>
        <div class="text-right">
          <div class="text-3xl font-bold" id="participantScore">0</div>
          <div class="text-blue-200">Points</div>
          <button onclick="logout()" class="mt-2 bg-blue-900 hover:bg-blue-800 px-4 py-2 rounded-lg transition-colors">Logout</button>
        </div>
      </div>
    </div>

    <div id="questionArea" class="bg-white rounded-2xl shadow-2xl p-8 mb-6 hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Battle Question</h2>
        <div class="relative w-16 h-16">
          <svg class="w-16 h-16 transform -rotate-90">
            <circle cx="32" cy="32" r="28" stroke="#e5e7eb" stroke-width="4" fill="none"></circle>
            <circle id="timerCircle" cx="32" cy="32" r="28" stroke="#f59e0b" stroke-width="4" fill="none" class="timer-ring"></circle>
          </svg>
          <div id="timerText" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-amber-600">30</div>
        </div>
      </div>
      <div id="participantImageWrap" class="mb-4 hidden">
        <img id="participantImage" class="w-full max-h-72 object-contain rounded-xl" alt="Question image"/>
      </div>
      <div id="participantQuestionText" class="text-xl text-gray-800 mb-6 p-4 bg-amber-50 rounded-xl border-l-4 border-amber-500">Waiting for question...</div>
      <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <div id="waitingArea" class="bg-white rounded-2xl shadow-xl p-8 text-center">
      <div class="text-6xl mb-4 animate-bounce">⚔️</div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Preparing for Battle</h2>
      <p class="text-gray-600">Waiting for the next question from the battle master...</p>
    </div>

    <!-- ==== PHOTO SHARING: Participant Uploader ==== -->
    <div id="photoShareCard" class="mt-6 bg-white rounded-2xl shadow-xl p-6 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">📸 Share a Battle Photo</h2>
      <p class="text-gray-600 mb-3">The battle master has opened photo sharing. Snap a pic and send it!</p>

      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
        <input id="photoInput" type="file" accept="image/*" capture="environment"
               class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200"/>
        <button onclick="uploadParticipantPhoto()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold px-4 py-2 rounded-lg">Upload</button>
      </div>

      <div class="mt-4 flex items-center gap-4">
        <img id="photoPreview" class="hidden w-40 h-40 object-cover rounded-xl border" alt="Preview"/>
        <div id="photoShareMsg" class="text-sm text-gray-600"></div>
      </div>

      <!-- ⚡ Fastest Finger (live) within the photo card -->
      <div class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-amber-800">⚡ Fastest Finger (Live)</h3>
          <button class="text-xs px-2 py-1 bg-amber-200 rounded hover:bg-amber-300" onclick="updatePhotoFastest()">Refresh</button>
        </div>
        <div id="photoFastestList" class="mt-3 text-amber-900 text-sm">Waiting for answers...</div>
      </div>
    </div>
    <!-- ==== /PHOTO SHARING ==== -->

    <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">🏆 Warrior Rankings</h2>
      <div id="participantLeaderboard" class="space-y-2"></div>
    </div>
  </div>
</div>

<!-- Post-login Loader Overlay (NEW) -->
<div id="loadingOverlay" class="fixed inset-0 z-[1000] hidden grid place-items-center bg-black/70 backdrop-blur-sm">
  <div class="flex flex-col items-center gap-4">
    <!-- Crest spinner (SVG) -->
    <svg id="loadingCrest" class="w-20 h-20 animate-spin-slow" viewBox="0 0 100 100" fill="none">
      <defs>
        <linearGradient id="molten" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#F59E0B"/>
          <stop offset="50%" stop-color="#D97706"/>
          <stop offset="100%" stop-color="#B45309"/>
        </linearGradient>
      </defs>
      <circle cx="50" cy="50" r="42" stroke="url(#molten)" stroke-width="6" opacity="0.5"/>
      <path d="M50 18 L65 38 L85 42 L70 58 L73 80 L50 70 L27 80 L30 58 L15 42 L35 38 Z"
            fill="url(#molten)" opacity="0.9"/>
    </svg>

    <!-- Copy that changes by role -->
    <div id="loadingCopy" class="text-amber-200 text-lg font-semibold">Sharpening Blades…</div>

    <!-- Progress bar -->
    <div class="w-64 h-2 bg-white/20 rounded-full overflow-hidden">
      <div id="loadingBar" class="h-full w-0 bg-amber-400 transition-[width] duration-300 ease-out"></div>
    </div>
  </div>
</div>

<script>
// ===================== SUPABASE =====================
const SUPABASE_URL = 'https://iondedmhlyonsmpqulhq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvbmRlZG1obHlvbnNtcHF1bGhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyOTQ2MjQsImV4cCI6MjA3NDg3MDYyNH0.WFo2SfBf_Z2_e6C_pSuT8YStTCAD9pdGo90JNrgZdzM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===================== STATE =====================
const STORAGE_KEY = 'warriorQuizState_v10';
const SETS_KEY = 'warriorQuizSets_v2';
const LAST_SET_KEY = 'warriorQuizLastSetName';
const SETS_TABLE = 'question_sets';

const PHOTO_TOGGLE_TABLE = 'photo_share_toggle';
const PHOTO_SHARES_TABLE = 'photo_shares';
const PHOTO_BUCKET = 'battle_photos';

let gameState = {
  currentUser: null,
  userType: null,
  participants: {},
  currentQuestion: null,
  questionTimer: null,
  prevRanks: {},
  setRunner: { running:false, queue:[], cursor:0, timerId:null, runId:null },
  photoShareAllowed: false,
  photoShareExpiresAt: null,
  photos: []
};
let photoCountdownTimerId = null;

const warriorAvatars = ['🏹','⚔️','🛡️','🗡️','🏺','🎯','⚡','🔥'];
const credentials = {
  admin: { username: 'admin', password: 'Thunder4554' },
  participants: {
    warrior1:'battle123', warrior2:'battle123', warrior3:'battle123', warrior4:'battle123',
    warrior5:'battle123', warrior6:'battle123', warrior7:'battle123', warrior8:'battle123'
  }
};

// ===== Presence (Realtime) =====
let presenceChannel = null;
let presenceRoster = new Set();
function joinPresence(usernameOrViewer){
  if (presenceChannel) { try { presenceChannel.unsubscribe(); } catch {} }
  presenceRoster = new Set();
  presenceChannel = sb.channel('arena-presence', { config: { presence: { key: usernameOrViewer } } });
  presenceChannel
    .on('presence', { event: 'sync' }, () => {
      const state = presenceChannel.presenceState();
      const names = new Set();
      Object.keys(state).forEach(key => { names.add(key); });
      presenceRoster = names;
      updateActiveParticipants();
      refreshAllLeaderboards();
    })
    .subscribe(async (status) => {
      if (status === 'SUBSCRIBED') { await presenceChannel.track({ at: new Date().toISOString() }); }
    });
}

// ===================== PERSISTENCE =====================
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    currentUser:gameState.currentUser,
    userType:gameState.userType,
    participants:gameState.participants,
    prevRanks:gameState.prevRanks,
    photoShareAllowed:gameState.photoShareAllowed,
    photoShareExpiresAt:gameState.photoShareExpiresAt
  }));
}
function loadState(){
  try{
    const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
    if(!s) return;
    gameState.currentUser=s.currentUser||null;
    gameState.userType=s.userType||null;
    gameState.participants=s.participants||{};
    gameState.prevRanks=s.prevRanks||{};
    gameState.photoShareAllowed=!!s.photoShareAllowed;
    gameState.photoShareExpiresAt = s.photoShareExpiresAt ?? null;
  }catch{}
}
function initializeParticipants(){
  if(Object.keys(gameState.participants).length) return;
  Object.keys(credentials.participants).forEach((u,i)=>{
    gameState.participants[u]={name:u,avatar:warriorAvatars[i],online:false};
  });
}

// ===================== HELPERS =====================
const isDirectImageUrl = (u) => /\.(png|jpe?g|gif|webp)(\?.*)?$/i.test(u||'');
const escapeHtml = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function makeRunId(){ return (crypto?.randomUUID?.() || ('run_'+Math.random().toString(36).slice(2)+'_'+Date.now())); }

// ========== Resilient realtime support ==========
let arenaHub = null;          // unified DB events channel
let lastEventAt = Date.now(); // heartbeat
const SOFT_REFRESH_MS = 6000; // if quiet for > this, poll

function bumpHeartbeat(){ lastEventAt = Date.now(); }

// Soft refresh: read-only updates
async function softRefresh(){
  try{
    await Promise.allSettled([
      fetchActiveQuestion(),
      refreshAllLeaderboards(),
      refreshFastestHistory(),
      updateFastestFinger(),
      updatePhotoFastest(),
      fetchPhotoShareAllowed(),
      (document.getElementById('adminDashboard')?.classList.contains('hidden') ? Promise.resolve() : refreshPhotoInbox())
    ]);
  }catch{}
}

// Unified realtime hub (replace many small channels)
function wireRealtime(){
  if (arenaHub) { try{ arenaHub.unsubscribe(); }catch{} }

  arenaHub = sb.channel('arena-hub');

  const tables = [
    'answers',
    'questions',
    'score_adjustments',
    'participant_flags',
    'photo_share_toggle',
    'photo_shares'
  ];

  tables.forEach(t => {
    arenaHub.on('postgres_changes', { event:'*', schema:'public', table: t }, payload => {
      bumpHeartbeat();
      switch(t){
        case 'answers':
          refreshAllLeaderboards();
          updateFastestFinger();
          refreshFastestHistory();
          updatePhotoFastest();
          break;
        case 'questions': {
          const q = payload.new;
          if (q && !q.ended && new Date(q.ends_at) > new Date()) setCurrentQuestion(q);
          else clearQuestionUI();
          refreshFastestHistory();
          break;
        }
        case 'score_adjustments':
        case 'participant_flags':
          refreshAllLeaderboards();
          break;
        case 'photo_share_toggle':
          fetchPhotoShareAllowed();
          break;
        case 'photo_shares':
          if (!document.getElementById('adminDashboard')?.classList.contains('hidden')) {
            refreshPhotoInbox();
          }
          break;
      }
    });
  });

  arenaHub.subscribe(status => { if (status === 'SUBSCRIBED') bumpHeartbeat(); });
}

// Watchdog: poll if realtime is quiet (sleeping tab / flaky net)
setInterval(() => {
  if (Date.now() - lastEventAt > SOFT_REFRESH_MS) { softRefresh(); bumpHeartbeat(); }
}, 2000);
document.addEventListener('visibilitychange', () => { if (!document.hidden) { softRefresh(); bumpHeartbeat(); }});
window.addEventListener('focus', () => { softRefresh(); bumpHeartbeat(); });

/* ========= Loader helpers (NEW) ========= */
function showLoader(roleText){
  const overlay = document.getElementById('loadingOverlay');
  const copy = document.getElementById('loadingCopy');
  const bar = document.getElementById('loadingBar');
  if(copy) copy.textContent = roleText || 'Loading…';
  if(bar){ bar.style.width = '0%'; }
  overlay.classList.remove('hidden');

  // fake-progress to 85% while real work happens
  let p = 0;
  overlay.__progTimer = setInterval(()=> {
    p = Math.min(85, p + 5);
    if(bar) bar.style.width = p + '%';
  }, 180);
}
function hideLoader(){
  const overlay = document.getElementById('loadingOverlay');
  const bar = document.getElementById('loadingBar');
  if(overlay.__progTimer) { clearInterval(overlay.__progTimer); }
  // complete to 100% then fade out
  if(bar) bar.style.width = '100%';
  setTimeout(()=> overlay.classList.add('hidden'), 200);
}
// ===================== LOGIN =====================
async function login(type){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!username||!password){ alert('Please enter both username and password!'); return; }

  // prevent duplicate warrior username login using presence roster
  if(type==='participant'){
    if (presenceRoster.has(username)) {
      alert('This warrior is already logged in on another device/browser. Please try a different username or log out there first.');
      return;
    }
  }

  let ok=false;
  if(type==='admin'){ ok = (username===credentials.admin.username && password===credentials.admin.password); }
  else { ok = credentials.participants[username]===password; }
  if(!ok){ alert('Invalid credentials!'); return; }

  // Start loader (role-specific copy)
  showLoader(type==='admin' ? 'Forging Commands…' : 'Sharpening Blades…');

  gameState.currentUser=username;
  gameState.userType=type;

  if(type==='participant'){
    if(!gameState.participants[username]) gameState.participants[username]={name:username,avatar:'⚔️',online:true};
    gameState.participants[username].online=true;
    document.getElementById('participantName').textContent=username;
    document.getElementById('participantAvatar').textContent=gameState.participants[username].avatar;
  }
  saveState();
  joinPresence(username);
  showDashboard(type);                // dashboard renders behind the overlay
  updateActiveParticipants();

  // Kick off initial data loads while the loader shows
  try{
    await Promise.allSettled([
      fetchActiveQuestion(),
      refreshAllLeaderboards(),
      (async()=>populateAdminSelect?.(true))(),
      (async()=>initPhotoSharingRealtime?.())(),
      fetchPhotoShareAllowed(),
      refreshPhotoInbox(),
      refreshFastestHistory(),
      updatePhotoFastest()
    ]);
    wireRealtime();
  } finally {
    hideLoader(); // overlay disappears once boot tasks settle
  }
}
function showDashboard(type){
  document.getElementById('loginScreen').classList.add('hidden');
  if(type==='admin') document.getElementById('adminDashboard').classList.remove('hidden');
  else {
    if(gameState.currentUser && gameState.participants[gameState.currentUser]) gameState.participants[gameState.currentUser].online=true;
    document.getElementById('participantDashboard').classList.remove('hidden');
    document.getElementById('participantName').textContent=gameState.currentUser||'Warrior';
    document.getElementById('participantAvatar').textContent=gameState.participants[gameState.currentUser]?.avatar||'⚔️';
  }
  applyPhotoShareVisibility();
}
function logout(){
  if(gameState.userType==='participant' && gameState.currentUser){
    gameState.participants[gameState.currentUser].online=false;
  }
  gameState.currentUser=null;
  gameState.userType=null;
  document.getElementById('adminDashboard').classList.add('hidden');
  document.getElementById('participantDashboard').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('username').value='';
  document.getElementById('password').value='';
  joinPresence('viewer-' + Math.random().toString(36).slice(2,8));
  updateActiveParticipants();
  saveState();
  refreshAllLeaderboards();
}

// ===================== ACTIVE QUESTION =====================
async function fetchActiveQuestion(){
  const { data, error } = await sb.from('questions')
    .select('*')
    .eq('ended', false)
    .gt('ends_at', new Date().toISOString())
    .order('start_time', { ascending: false })
    .limit(1);
  if(error){ console.error('fetchActiveQuestion error', error); return; }
  if(data && data.length){ setCurrentQuestion(data[0]); }
  else { clearQuestionUI(); }
}
function setCurrentQuestion(q){
  gameState.currentQuestion = {
    id:q.id, text:q.text, options:q.options, correct:q.correct,
    timer:q.timer, points:q.points||100, image_url:q.image_url||null,
    startTime:new Date(q.start_time).getTime(),
    endsAt:new Date(q.ends_at).getTime()
  };
  if(gameState.userType==='participant') displayQuestionToParticipants();
  startOrSyncTimer();
  updateCurrentQuestionStatus();
  updateFastestFinger();
  updatePhotoFastest();
}
function clearQuestionUI(){
  gameState.currentQuestion=null;
  if(gameState.userType==='participant'){
    document.getElementById('questionArea').classList.add('hidden');
    document.getElementById('waitingArea').classList.remove('hidden');
  }
  updateCurrentQuestionStatus();
  const ff=document.getElementById('fastestFinger');
  if(ff) ff.innerText='Waiting for answers...';
  updatePhotoFastest();
}

// ===================== PARTICIPANT VIEW =====================
function displayQuestionToParticipants(){
  const qa=document.getElementById('questionArea');
  const wa=document.getElementById('waitingArea');
  const q=gameState.currentQuestion;
  if(!q){ qa.classList.add('hidden'); wa.classList.remove('hidden'); return; }
  wa.classList.add('hidden'); qa.classList.remove('hidden');

  const imgWrap=document.getElementById('participantImageWrap');
  const img=document.getElementById('participantImage');
  if(q.image_url && q.image_url.trim() !== ''){ imgWrap.classList.remove('hidden'); img.src=q.image_url; }
  else { imgWrap.classList.add('hidden'); img.src=''; }

  document.getElementById('participantQuestionText').textContent=`${q.text} (Points: ${q.points})`;
  const optionsContainer=document.getElementById('optionsContainer');
  optionsContainer.innerHTML='';
  Object.entries(q.options).forEach(([key,val])=>{
    const btn=document.createElement('button');
    btn.dataset.key=key;
    btn.className='bg-gradient-to-r from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 text-left';
    btn.innerHTML=`<span class="text-xl font-bold">${key}.</span> ${val}`;
    btn.onclick=()=>submitAnswer(key);
    optionsContainer.appendChild(btn);
  });
}
function confettiBurst(){
  for(let i=0;i<36;i++){
    const d=document.createElement('div');
    d.className='confetti';
    d.style.left=Math.random()*100+'vw';
    d.style.background=`hsl(${Math.random()*360},80%,60%)`;
    d.style.animation=`fall ${1.2+Math.random()*1.2}s linear forwards`;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 2400);
  }
}
async function submitAnswer(answer){
  const q=gameState.currentQuestion;
  if(!q||!gameState.currentUser) return;
  if(Date.now()>=q.endsAt){ endQuestion(); return; }
  const now=Date.now();
  const timeTaken=now-q.startTime;
  const isCorrect=(answer===q.correct);
  disableAndHighlight(answer,q.correct);
  const { error } = await sb.from('answers').insert({
    question_id:q.id, username:gameState.currentUser, answer, time_ms:timeTaken, is_correct:isCorrect
  });
  if(error){ console.warn('submitAnswer error', error); return; }
  if(isCorrect) confettiBurst();
  setTimeout(()=>{
    refreshAllLeaderboards();
    updateFastestFinger();
    refreshFastestHistory();
    updatePhotoFastest();
  }, 150);
}
function disableAndHighlight(answer, correct){
  const buttons=[...document.querySelectorAll('#optionsContainer button')];
  buttons.forEach(b=>{ b.disabled=true; b.classList.add('opacity-50','cursor-not-allowed'); });
  buttons.forEach(btn=>{
    const key=btn.dataset.key;
    if(key===correct){ btn.classList.remove('from-amber-400','to-amber-600'); btn.classList.add('from-green-400','to-green-600'); }
    else if(key===answer&&answer!==correct){ btn.classList.remove('from-amber-400','to-amber-600'); btn.classList.add('from-red-400','to-red-600'); }
  });
}

// ===================== TIMER =====================
function startOrSyncTimer(){
  clearInterval(gameState.questionTimer);
  const q=gameState.currentQuestion; if(!q) return;
  const circle=document.getElementById('timerCircle');
  const text=document.getElementById('timerText');
  function tick(){
    const now=Date.now();
    const remainingMs=q.endsAt-now;
    const remaining=Math.max(0,Math.ceil(remainingMs/1000));
    if(text) text.textContent=remaining;
    if(circle){
      const elapsed=Math.min(q.timer,Math.max(0,Math.floor((now-q.startTime)/1000)));
      const progress=elapsed/q.timer;
      const offset=283-progress*283;
      circle.style.strokeDashoffset=offset;
    }
    if(remaining<=0){ clearInterval(gameState.questionTimer); endQuestion(); }
  }
  tick();
  gameState.questionTimer=setInterval(tick,1000);
}
async function endQuestion(){
  clearInterval(gameState.questionTimer);
  gameState.questionTimer=null;
  gameState.currentQuestion=null;
  if(gameState.userType==='participant'){
    document.getElementById('questionArea').classList.add('hidden');
    document.getElementById('waitingArea').classList.remove('hidden');
  }
  updateCurrentQuestionStatus();
  updateFastestFinger();
  refreshAllLeaderboards();
  refreshFastestHistory();
  updatePhotoFastest();
  saveState();
}

// ===================== LEADERBOARD =====================
function pointsFromAnswer(record, qMap){
  if(!record.is_correct) return 0;
  const q = qMap[record.question_id];
  return q ? (q.points || 100) : 100;
}
async function computeLeaderboard(){
  const users = Object.keys(credentials.participants);

  // Pull answers with time_ms so we can compute tiebreakers
  const [{ data: answers }, { data: qs }] = await Promise.all([
    sb.from('answers').select('username,question_id,is_correct,time_ms'),
    sb.from('questions').select('id,points')
  ]);

  const qMap = Object.fromEntries((qs||[]).map(q=>[q.id, q]));

  // Totals and tie-times
  const totals = {};         // username -> points
  const bestTimes = {};      // username -> sum of best (fastest) correct times across questions

  // For each user/question, keep the minimum correct time to avoid double-counting
  const perUserPerQBest = {}; // username -> { qid -> minTimeMs }

  (answers||[]).forEach(r=>{
    // points
    if(!totals[r.username]) totals[r.username]=0;
    totals[r.username]+=pointsFromAnswer(r, qMap);

    // tie time: only count correct answers
    if (r.is_correct) {
      if (!perUserPerQBest[r.username]) perUserPerQBest[r.username] = {};
      const prev = perUserPerQBest[r.username][r.question_id];
      const t = Math.max(0, Number(r.time_ms||0));
      if (prev === undefined || t < prev) perUserPerQBest[r.username][r.question_id] = t;
    }
  });

  // Sum best times per user
  Object.keys(perUserPerQBest).forEach(u=>{
    bestTimes[u] = Object.values(perUserPerQBest[u]).reduce((a,b)=>a+b,0);
  });

  // Admin adjustments
  const { data: adj } = await sb.from('score_adjustments').select('username,delta');
  (adj||[]).forEach(a=>{
    if(!totals[a.username]) totals[a.username]=0;
    totals[a.username]+=(a.delta||0);
  });

  // Removed participants
  const { data: flags } = await sb.from('participant_flags').select('username,removed');
  const removed = new Set((flags||[]).filter(f=>f.removed).map(f=>f.username));

  // Ensure all users exist
  users.forEach(u=>{ if(!totals[u]) totals[u]=0; if(!bestTimes[u]) bestTimes[u]=Number.POSITIVE_INFINITY; });

  // Build rows with tieBreak field
  const rows = Object.entries(totals)
    .filter(([u,_])=>!removed.has(u))
    .map(([u,score])=>({
      name:u,
      score,
      tieTime: bestTimes[u], // smaller is better
      avatar: gameState.participants[u]?.avatar||'⚔️',
      online: presenceRoster.has(u)
    }))
    // Sort: score desc, tieTime asc, name asc
    .sort((a,b)=>{
      if (b.score !== a.score) return b.score - a.score;
      const at = isFinite(a.tieTime) ? a.tieTime : Number.POSITIVE_INFINITY;
      const bt = isFinite(b.tieTime) ? b.tieTime : Number.POSITIVE_INFINITY;
      if (at !== bt) return at - bt;
      return a.name.localeCompare(b.name);
    });

  return rows;
}

let chartInstance = null;
async function refreshAllLeaderboards(){
  const rows = await computeLeaderboard();
  renderLeaderboard('loginLeaderboard', rows);
  renderLeaderboard('adminLeaderboard', rows);
  renderLeaderboard('participantLeaderboard', rows);

  const canvas = document.getElementById('leaderboardChart');
  if(canvas && !document.getElementById('leaderboardModal').classList.contains('hidden')){
    const labels = rows.map(r=>r.name);
    const scores = rows.map(r=>r.score);
    const ctx = canvas.getContext('2d');
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Points',
          data: scores,
          borderWidth: 2,
          borderRadius: 10,
          borderColor: '#ffffff',
          backgroundColor: ['#f87171','#fb923c','#fbbf24','#34d399','#60a5fa','#a78bfa','#f472b6','#facc15']
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, animation: { duration: 1000, easing: 'easeOutCubic' },
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { color: '#6b7280' }, grid: { display:false } }, y: { beginAtZero: true, ticks: { color: '#6b7280' } } }
      }
    });
  }

  if(gameState.userType==='participant' && gameState.currentUser){
    const me=rows.find(r=>r.name===gameState.currentUser);
    if(me) document.getElementById('participantScore').textContent=me.score;
  }
  populateAdminSelect(true);
}
function renderLeaderboard(containerId, rows){
  const el=document.getElementById(containerId);
  if(!el) return;
  const prev=gameState.prevRanks||{};
  const mapRank={};
  rows.forEach((r,i)=>mapRank[r.name]=i+1);
  el.innerHTML = rows.map((p,i)=>{
    const medal=i===0?'🥇':i===1?'🥈':i===2?'🥉':'🏅';
    const status=p.online?'<span class="text-green-600">Online</span>':'<span class="text-gray-400">Offline</span>';
    const me=p.name===gameState.currentUser && gameState.userType==='participant';
    const hl=me?'ring-2 ring-blue-500 bg-blue-50':'bg-gradient-to-r from-amber-50 to-orange-50';
    const jump=(prev[p.name] && prev[p.name]>(i+1))?'rank-jump':'';
    return `<div class="flex items-center justify-between p-3 ${hl} ${jump} rounded-xl border border-amber-200">
      <div class="flex items-center space-x-4">
        <span class="text-2xl">${medal}</span>
        <span class="text-2xl">${p.avatar}</span>
        <div>
          <div class="font-bold text-gray-800">${p.name} ${me?'(You)':''}</div>
          <div class="text-sm text-gray-600">Rank #${i+1} • ${status}</div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-xl font-bold text-amber-600">${p.score}</div>
        <div class="text-xs text-gray-600">points</div>
      </div>
    </div>`;
  }).join('');
  gameState.prevRanks = mapRank;
  saveState();
}

// ====== FASTEST FINGER (CURRENT) ======
async function updateFastestFinger(){
  const el=document.getElementById('fastestFinger'); if(!el) return;
  const q=gameState.currentQuestion;
  if(!q){ el.textContent='Waiting for answers...'; return; }

  const { data, error } = await sb.from('answers').select('username,time_ms,is_correct').eq('question_id', q.id);
  if(error){ console.error('fastest error', error); el.textContent='Waiting for answers...'; return; }

  const correct=(data||[]).filter(r=>r.is_correct);
  if(!correct.length){ el.textContent='No correct answers yet...'; return; }
  correct.sort((a,b)=>a.time_ms-b.time_ms);
  const f=correct[0];
  const avatar=gameState.participants[f.username]?.avatar||'⚡';
  el.innerHTML = `${avatar} ${f.username} (${(f.time_ms/1000).toFixed(1)}s)`;

  const statusEl=document.getElementById('currentQuestionStatus');
  if(statusEl) statusEl.textContent=`Active - ${(data||[]).length} warriors answered`;
}
function updateCurrentQuestionStatus(){
  const el = document.getElementById('currentQuestionStatus');
  if(!el) return;
  if(gameState.currentQuestion) return;
  el.textContent = 'No active question';
}
function updateActiveParticipants(){
  const count = Array.from(presenceRoster).filter(u => /^warrior[1-8]$/.test(u)).length;
  const el=document.getElementById('activeParticipants');
  if(el) el.textContent=`${count} warriors online`;
}

// ====== FASTEST FINGER HISTORY (scoped to current run) ======
async function refreshFastestHistory(){
  const btn = document.getElementById('ffRefreshBtn');
  if(btn){ btn.disabled = true; btn.textContent = 'Loading...'; }

  try{
    let runId = gameState.setRunner?.runId || null;
    if(!runId){
      const { data: lastQ } = await sb.from('questions')
        .select('run_id,start_time')
        .order('start_time', { ascending:false })
        .limit(1);
      if(lastQ && lastQ.length && lastQ[0].run_id) runId = lastQ[0].run_id;
    }

    let qList = [];
    if(runId){
      const { data: qs, error: qErr } = await sb.from('questions')
        .select('id,text,start_time')
        .eq('run_id', runId)
        .order('start_time', { ascending:false });
      if(qErr) throw qErr;
      qList = qs || [];
    }else{
      const dayStart = new Date(); dayStart.setHours(0,0,0,0);
      const { data: qs, error: qErr } = await sb.from('questions')
        .select('id,text,start_time')
        .gte('start_time', dayStart.toISOString())
        .order('start_time', { ascending:false });
      if(qErr) throw qErr;
      qList = qs || [];
    }

    if(!qList.length){
      document.getElementById('ffHead').innerHTML='';
      document.getElementById('ffBody').innerHTML='';
      document.getElementById('ffMsg').textContent='No questions for this run yet.';
      return;
    }

    const qIds = qList.map(q=>q.id);
    const { data: ans, error: aErr } = await sb.from('answers')
      .select('question_id,username,time_ms,is_correct')
      .in('question_id', qIds);
    if(aErr) throw aErr;

    const users = Object.keys(credentials.participants);
    const headHtml = `
      <tr class="bg-gray-50">
        <th class="px-3 py-2 text-left font-semibold text-gray-700">Question</th>
        ${users.map(u=>`<th class="px-2 py-2 text-center font-semibold text-gray-700">${u}</th>`).join('')}
      </tr>`;
    document.getElementById('ffHead').innerHTML = headHtml;

    const byQ = {};
    (ans||[]).forEach(r=>{
      if(!byQ[r.question_id]) byQ[r.question_id] = {};
      byQ[r.question_id][r.username] = r;
    });

    const bodyHtml = qList.map((q, idx)=>{
      const qLabel = `Q${qList.length - idx}`;
      const rowCells = users.map(u=>{
        const rec = (byQ[q.id]||{})[u];
        if(!rec) return `<td class="ff-cell px-2 py-2 text-gray-300">—</td>`;
        const s = (rec.time_ms/1000).toFixed(1)+'s';
        const good = rec.is_correct;
        const badgeClass = good ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const mark = good ? '✔' : '✖';
        return `<td class="ff-cell px-2 py-2">
          <span class="ff-badge ${badgeClass}" title="${good?'Correct':'Wrong'}">${s} ${mark}</span>
        </td>`;
      }).join('');
      const qTextSafe = escapeHtml(q.text||'');
      return `<tr class="border-b">
        <td class="px-3 py-2">
          <div class="font-semibold text-gray-800">${qLabel}</div>
          <div class="text-xs text-gray-500 truncate max-w-[380px]" title="${qTextSafe}">${qTextSafe}</div>
        </td>
        ${rowCells}
      </tr>`;
    }).join('');

    document.getElementById('ffBody').innerHTML = bodyHtml;
    document.getElementById('ffMsg').textContent =
      `Showing ${qList.length} question(s) for this run. ✔ correct, ✖ wrong.`;
  }catch(e){
    console.error('refreshFastestHistory', e);
    const msg=document.getElementById('ffMsg');
    if(msg) msg.textContent='❌ Failed to load fastest finger history.';
  }finally{
    if(btn){ btn.disabled = false; btn.textContent = 'Refresh'; }
  }
}

/* ====== MINI FASTEST LIST inside Photo Card (now also renders in Admin) ====== */
async function updatePhotoFastest(){
  const el1 = document.getElementById('photoFastestList');        // participant
  const el2 = document.getElementById('photoFastestListAdmin');   // admin
  if(!el1 && !el2) return;

  try{
    let q = gameState.currentQuestion;

    if(!q){
      let runId = gameState.setRunner?.runId || null;
      if(!runId){
        const { data: lastQ } = await sb.from('questions')
          .select('run_id,start_time')
          .order('start_time', { ascending:false })
          .limit(1);
        if(lastQ && lastQ.length && lastQ[0].run_id) runId = lastQ[0].run_id;
      }
      let qd;
      if(runId){
        ({ data: qd } = await sb.from('questions')
          .select('id,text,start_time')
          .eq('run_id', runId)
          .order('start_time', { ascending:false })
          .limit(1));
      }else{
        const dayStart = new Date(); dayStart.setHours(0,0,0,0);
        ({ data: qd } = await sb.from('questions')
          .select('id,text,start_time')
          .gte('start_time', dayStart.toISOString())
          .order('start_time', { ascending:false })
          .limit(1));
      }
      if(qd && qd.length) q = { id: qd[0].id, text: qd[0].text };
    }

    const targetEls = [el1, el2].filter(Boolean);

    if(!q){ targetEls.forEach(e=>e.textContent='No questions yet.'); return; }

    const { data: answers } = await sb.from('answers')
      .select('username,time_ms,is_correct')
      .eq('question_id', q.id);

    if(!answers || !answers.length){ targetEls.forEach(e=>e.textContent='No answers yet...'); return; }

    const rows = answers
      .map(a=>({ ...a, s: (a.time_ms/1000).toFixed(1) }))
      .sort((a,b)=>a.time_ms-b.time_ms);

    const html = rows.map((r,i)=>{
      const place = i===0?'🥇':i===1?'🥈':i===2?'🥉':'🏅';
      const avatar = gameState.participants[r.username]?.avatar || '⚡';
      const mark = r.is_correct ? '✔' : '✖';
      const clr = r.is_correct ? 'text-green-700' : 'text-red-700';
      return `<div class="flex items-center justify-between py-1">
        <div class="flex items-center gap-2">
          <span>${place}</span>
          <span class="text-xl">${avatar}</span>
          <span class="font-semibold">${r.username}</span>
        </div>
        <div class="font-bold ${clr}">${r.s}s ${mark}</div>
      </div>`;
    }).join('');

    targetEls.forEach(e=>e.innerHTML = html);
  }catch(err){
    console.error('updatePhotoFastest', err);
    [el1, el2].filter(Boolean).forEach(e=>e.textContent='❌ Could not load fastest data.');
  }
}
/* =================== /PHOTO SHARING =================== */

// ===================== GLOBAL HELPERS =====================
function openLeaderboardModal(){
  document.getElementById('leaderboardModal').classList.remove('hidden');
  setTimeout(()=>refreshAllLeaderboards(), 200);
}
function closeLeaderboardModal(){
  document.getElementById('leaderboardModal').classList.add('hidden');
}

// ===================== BOOT =====================
(function boot(){
  loadState();
  initializeParticipants();
  if (gameState.userType && gameState.currentUser) joinPresence(gameState.currentUser);
  else joinPresence('viewer-' + Math.random().toString(36).slice(2,8));

  if(gameState.userType){ showDashboard(gameState.userType); }
  loadSavedSetsDropdown();
  populateAdminSelect(true);
  fetchActiveQuestion();
  refreshAllLeaderboards();

  initPhotoSharingRealtime();
  fetchPhotoShareAllowed();
  refreshPhotoInbox();

  const input = document.getElementById('photoInput');
  if(input){
    input.addEventListener('change', ()=>{
      const f=input.files && input.files[0];
      const prev=document.getElementById('photoPreview');
      if(f){ prev.src = URL.createObjectURL(f); prev.classList.remove('hidden'); setPhotoMsg('Ready to upload.'); }
      else { prev.src=''; prev.classList.add('hidden'); setPhotoMsg(''); }
    });
  }

  // Initial fastest history + photo mini
  refreshFastestHistory();
  updatePhotoFastest();

  window.addEventListener('beforeunload', saveState);
})();
</script>
</body>
</html>

