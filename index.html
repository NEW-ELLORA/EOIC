<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Warrior Quiz Arena - Ancient Indian Battle (Supabase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    body { box-sizing: border-box; }
    .warrior-bg { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%); }
    .ancient-pattern {
      background-image:
        radial-gradient(circle at 25% 25%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(255, 69, 0, 0.1) 0%, transparent 50%);
    }
    .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
    /* Confetti + rank jump */
    .confetti { position: fixed; top: -10px; width: 8px; height: 14px; opacity: .9; transform: rotate(15deg); pointer-events:none; }
    @keyframes fall { to { transform: translateY(110vh) rotate(360deg); opacity: 1; } }
    .rank-jump { animation: rankJump .6s ease-out; }
    @keyframes rankJump { 0%{transform: translateY(0)} 30%{transform: translateY(-14px)} 100%{transform: translateY(0)} }
  </style>
</head>
<body class="warrior-bg ancient-pattern min-h-screen">
  <!-- Login Screen with public leaderboard -->
  <div id="loginScreen" class="min-h-screen p-4 flex items-start justify-center">
    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Login Card -->
      <div class="bg-gradient-to-br from-amber-100 to-orange-100 rounded-3xl shadow-2xl p-8 w-full border-4 border-amber-600">
        <div class="text-center mb-8">
          <div class="text-6xl mb-4">⚔️</div>
          <h1 class="text-3xl font-bold text-amber-900 mb-2">Warrior Quiz Arena</h1>
          <p class="text-amber-700">Enter the Ancient Battle</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-amber-800 font-semibold mb-2">Username</label>
            <input type="text" id="username" class="w-full px-4 py-3 rounded-xl border-2 border-amber-300 focus:border-amber-600 focus:outline-none" placeholder="Enter username"/>
          </div>

          <div>
            <label class="block text-amber-800 font-semibold mb-2">Password</label>
            <input type="password" id="password" class="w-full px-4 py-3 rounded-xl border-2 border-amber-300 focus:border-amber-600 focus:outline-none" placeholder="Enter password"/>
          </div>

          <div class="flex space-x-4">
            <button onclick="login('admin')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">🛡️ Admin</button>
            <button onclick="login('participant')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">⚔️ Warrior</button>
          </div>
        </div>

        <div class="mt-6 text-sm text-amber-700 bg-amber-50 p-4 rounded-xl">
          <p><strong>Admin:</strong> admin / admin123</p>
          <p><strong>Warriors:</strong> warrior1-8 / battle123</p>
        </div>
      </div>

      <!-- Public Leaderboard on Login -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-2xl p-6 w-full border-4 border-orange-300">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">🏆 Live Leaderboard</h2>
        <div id="loginLeaderboard" class="space-y-2"></div>
        <div class="text-xs text-gray-500 mt-3">Auto-updates when warriors answer.</div>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="hidden min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
      <div class="bg-gradient-to-r from-red-800 to-red-600 rounded-2xl p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-bold flex items-center">🛡️ Admin Command Center</h1>
            <p class="text-red-200">Control the Ancient Battle Arena</p>
          </div>
          <button onclick="logout()" class="bg-red-900 hover:bg-red-800 px-4 py-2 rounded-lg transition-colors">Logout</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Question Management -->
        <div class="bg-white rounded-2xl shadow-xl p-6 lg:col-span-2">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">📜 Question Scroll</h2>

          <div class="space-y-4">
            <input type="text" id="adminQuestionText" placeholder="Enter your battle question..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>

            <div class="grid grid-cols-2 gap-2">
              <input type="text" id="adminOptionA" placeholder="Option A" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
              <input type="text" id="adminOptionB" placeholder="Option B" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
              <input type="text" id="adminOptionC" placeholder="Option C" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
              <input type="text" id="adminOptionD" placeholder="Option D" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
            </div>

            <div class="flex space-x-4">
              <select id="adminCorrectAnswer" class="flex-1 px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none">
                <option value="">Select Correct Answer</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>

              <input type="number" id="adminQuestionTimer" placeholder="Timer (sec)" min="10" max="120" value="30" class="w-24 px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
            </div>

            <button onclick="postQuestion()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">🏹 Launch Question</button>
          </div>
        </div>

        <!-- Live Stats + Admin Controls -->
        <div class="space-y-6">
          <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">⚡ Battle Statistics</h2>
            <div class="space-y-4">
              <div class="bg-green-50 p-4 rounded-xl">
                <h3 class="font-bold text-green-800 mb-2">⚡ Fastest Finger</h3>
                <div id="fastestFinger" class="text-green-600">Waiting for answers...</div>
              </div>
              <div class="bg-blue-50 p-4 rounded-xl">
                <h3 class="font-bold text-blue-800 mb-2">👥 Active Warriors</h3>
                <div id="activeParticipants" class="text-blue-600">0 / 8 warriors online</div>
              </div>
              <div class="bg-purple-50 p-4 rounded-xl">
                <h3 class="font-bold text-purple-800 mb-2">📊 Current Question</h3>
                <div id="currentQuestionStatus" class="text-purple-600">No active question</div>
              </div>
            </div>
          </div>

          <!-- Admin manual scoring -->
          <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">🧮 Points & Participants</h2>
            <div class="space-y-3">
              <select id="adminSelectUser" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"></select>
              <input id="adminDelta" type="number" placeholder="Points (+ or -)" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
              <input id="adminReason" type="text" placeholder="Reason (e.g., Bonus for bravery)" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none"/>
              <div class="flex gap-2">
                <button onclick="adminAddPoints()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg">➕ Add / ➖ Subtract</button>
                <button onclick="adminRemoveParticipant(true)" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">🗑️ Remove</button>
                <button onclick="adminRemoveParticipant(false)" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">♻️ Restore</button>
              </div>
              <div id="adminActionMsg" class="text-sm text-gray-600"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Leaderboard -->
      <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">🏆 Warrior Leaderboard</h2>
        <div id="adminLeaderboard" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Participant Dashboard -->
  <div id="participantDashboard" class="hidden min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <div class="bg-gradient-to-r from-blue-800 to-blue-600 rounded-2xl p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-4">
            <div id="participantAvatar" class="text-4xl"></div>
            <div>
              <h1 class="text-2xl font-bold" id="participantName">Warrior</h1>
              <p class="text-blue-200">Ready for Battle</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-3xl font-bold" id="participantScore">0</div>
            <div class="text-blue-200">Points</div>
            <button onclick="logout()" class="mt-2 bg-blue-900 hover:bg-blue-800 px-4 py-2 rounded-lg transition-colors">Logout</button>
          </div>
        </div>
      </div>

      <!-- Question Area -->
      <div id="questionArea" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Battle Question</h2>
          <div class="relative w-16 h-16">
            <svg class="w-16 h-16 transform -rotate-90">
              <circle cx="32" cy="32" r="28" stroke="#e5e7eb" stroke-width="4" fill="none"></circle>
              <circle id="timerCircle" cx="32" cy="32" r="28" stroke="#f59e0b" stroke-width="4" fill="none" class="timer-ring"></circle>
            </svg>
            <div id="timerText" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-amber-600">30</div>
          </div>
        </div>

        <div id="participantQuestionText" class="text-xl text-gray-800 mb-6 p-4 bg-amber-50 rounded-xl border-l-4 border-amber-500">Waiting for question...</div>
        <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- Waiting Area -->
      <div id="waitingArea" class="bg-white rounded-2xl shadow-xl p-8 text-center">
        <div class="text-6xl mb-4 animate-bounce">⚔️</div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Preparing for Battle</h2>
        <p class="text-gray-600">Waiting for the next question from the battle master...</p>
      </div>

      <!-- Participant Leaderboard -->
      <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">🏆 Warrior Rankings</h2>
        <div id="participantLeaderboard" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    // ===================== SUPABASE CONFIG =====================
    const SUPABASE_URL = 'https://iondedmhlyonsmpqulhq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvbmRlZG1obHlvbnNtcHF1bGhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyOTQ2MjQsImV4cCI6MjA3NDg3MDYyNH0.WFo2SfBf_Z2_e6C_pSuT8YStTCAD9pdGo90JNrgZdzM';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (function sanity(){
      if(!sb || typeof sb.from !== 'function') alert('Supabase client not initialized. Check script order.');
    })();

    // ===================== LOCAL PERSISTENCE =====================
    const STORAGE_KEY = 'warriorQuizState_v6';
    let gameState = {
      currentUser: null,
      userType: null,
      participants: {},
      currentQuestion: null,
      questionTimer: null,
      prevRanks: {}, // for jump animation
    };

    const warriorAvatars = ['🏹','⚔️','🛡️','🗡️','🏺','🎯','⚡','🔥'];
    const credentials = {
      admin: { username: 'admin', password: 'admin123' },
      participants: { warrior1:'battle123', warrior2:'battle123', warrior3:'battle123', warrior4:'battle123', warrior5:'battle123', warrior6:'battle123', warrior7:'battle123', warrior8:'battle123' }
    };

    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({currentUser:gameState.currentUser,userType:gameState.userType,participants:gameState.participants,prevRanks:gameState.prevRanks})); }
    function loadState(){ try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(!s) return; gameState.currentUser=s.currentUser||null; gameState.userType=s.userType||null; gameState.participants=s.participants||{}; gameState.prevRanks=s.prevRanks||{}; }catch{} }
    function initializeParticipants(){ if(Object.keys(gameState.participants).length) return;
      Object.keys(credentials.participants).forEach((u,i)=>{ gameState.participants[u]={name:u,avatar:warriorAvatars[i],online:false}; });
    }

    // ===================== AUTH (local demo) =====================
    function login(type){
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if(!username||!password){ alert('Please enter both username and password!'); return; }
      let ok=false; if(type==='admin'){ ok = (username===credentials.admin.username && password===credentials.admin.password); } else { ok = credentials.participants[username]===password; }
      if(!ok){ alert('Invalid credentials!'); return; }
      gameState.currentUser=username; gameState.userType=type;
      if(type==='participant'){
        if(!gameState.participants[username]) gameState.participants[username]={name:username,avatar:'⚔️',online:true};
        gameState.participants[username].online=true;
        document.getElementById('participantName').textContent=username;
        document.getElementById('participantAvatar').textContent=gameState.participants[username].avatar;
      }
      showDashboard(type); updateActiveParticipants(); saveState();
      fetchActiveQuestion();
      refreshAllLeaderboards();
      populateAdminSelect();
    }

    function showDashboard(t){ document.getElementById('loginScreen').classList.add('hidden'); if(t==='admin') document.getElementById('adminDashboard').classList.remove('hidden'); else document.getElementById('participantDashboard').classList.remove('hidden'); }
    function logout(){ if(gameState.userType==='participant' && gameState.currentUser){ gameState.participants[gameState.currentUser].online=false; }
      gameState.currentUser=null; gameState.userType=null;
      document.getElementById('adminDashboard').classList.add('hidden'); document.getElementById('participantDashboard').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('username').value=''; document.getElementById('password').value='';
      updateActiveParticipants(); saveState(); refreshAllLeaderboards();
    }

    // ===================== QUESTIONS =====================
    async function fetchActiveQuestion(){
      const { data, error } = await sb.from('questions').select('*').eq('ended', false).gt('ends_at', new Date().toISOString()).order('start_time', { ascending: false }).limit(1);
      if(error){ console.error('fetchActiveQuestion error', error); return; }
      if(data && data.length){ setCurrentQuestion(data[0]); } else { clearQuestionUI(); }
    }
    function setCurrentQuestion(q){
      gameState.currentQuestion = { id:q.id, text:q.text, options:q.options, correct:q.correct, timer:q.timer, startTime:new Date(q.start_time).getTime(), endsAt:new Date(q.ends_at).getTime() };
      if(gameState.userType==='participant') displayQuestionToParticipants();
      startOrSyncTimer(); updateCurrentQuestionStatus(); updateFastestFinger();
    }
    function clearQuestionUI(){
      gameState.currentQuestion=null;
      if(gameState.userType==='participant'){ document.getElementById('questionArea').classList.add('hidden'); document.getElementById('waitingArea').classList.remove('hidden'); }
      updateCurrentQuestionStatus(); const ff=document.getElementById('fastestFinger'); if(ff) ff.innerText='Waiting for answers...';
    }

    sb.channel('questions-listen')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'questions' }, ({new: q}) => { if(!q.ended && new Date(q.ends_at)>new Date()) setCurrentQuestion(q); })
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'questions' }, ({new: q}) => { if(q.ended || new Date(q.ends_at)<=new Date()) clearQuestionUI(); else setCurrentQuestion(q); })
      .subscribe();

    // ===================== ADMIN: POST QUESTION =====================
    async function postQuestion(){
      const questionText = document.getElementById('adminQuestionText').value.trim();
      const optionA = document.getElementById('adminOptionA').value.trim();
      const optionB = document.getElementById('adminOptionB').value.trim();
      const optionC = document.getElementById('adminOptionC').value.trim();
      const optionD = document.getElementById('adminOptionD').value.trim();
      const correctAnswer = document.getElementById('adminCorrectAnswer').value;
      const timer = parseInt(document.getElementById('adminQuestionTimer').value)||30;
      if(!questionText||!optionA||!optionB||!optionC||!optionD||!correctAnswer){ alert('Please fill in all fields!'); return; }
      await sb.from('questions').update({ ended:true }).eq('ended', false);
      const start = new Date(); const ends = new Date(start.getTime()+timer*1000);
      const payload = { text:questionText, options:{A:optionA,B:optionB,C:optionC,D:optionD}, correct:correctAnswer, timer, start_time:start.toISOString(), ends_at:ends.toISOString(), ended:false };
      const { data, error } = await sb.from('questions').insert(payload).select('*').single();
      if(error){ console.error('postQuestion error', error); alert('Could not post question.'); return; }
      ['adminQuestionText','adminOptionA','adminOptionB','adminOptionC','adminOptionD'].forEach(id=>document.getElementById(id).value=''); document.getElementById('adminCorrectAnswer').value='';
      setCurrentQuestion(data);
    }

    // ===================== PARTICIPANTS: DISPLAY & ANSWER =====================
    function displayQuestionToParticipants(){
      const qa=document.getElementById('questionArea'); const wa=document.getElementById('waitingArea'); const q=gameState.currentQuestion; if(!q){ qa.classList.add('hidden'); wa.classList.remove('hidden'); return; }
      wa.classList.add('hidden'); qa.classList.remove('hidden');
      document.getElementById('participantQuestionText').textContent=q.text;
      const optionsContainer=document.getElementById('optionsContainer'); optionsContainer.innerHTML='';
      Object.entries(q.options).forEach(([key,val])=>{
        const btn=document.createElement('button'); btn.dataset.key=key;
        btn.className='bg-gradient-to-r from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 text-left';
        btn.innerHTML=`<span class="text-xl font-bold">${key}.</span> ${val}`; btn.onclick=()=>submitAnswer(key); optionsContainer.appendChild(btn);
      });
    }

    function confettiBurst(){
      for(let i=0;i<40;i++){
        const d=document.createElement('div'); d.className='confetti'; d.style.left=Math.random()*100+'vw';
        d.style.background=`hsl(${Math.random()*360},80%,60%)`;
        d.style.animation=`fall ${1.2+Math.random()*1.2}s linear forwards`; d.style.transform=`rotate(${Math.random()*360}deg)`;
        document.body.appendChild(d); setTimeout(()=>d.remove(), 2500);
      }
    }

    async function submitAnswer(answer){
      const q=gameState.currentQuestion; if(!q||!gameState.currentUser) return;
      if(Date.now()>=q.endsAt){ endQuestion(); return; }
      const now=Date.now(); const timeTaken=now-q.startTime; const isCorrect=(answer===q.correct);
      disableAndHighlight(answer,q.correct);
      const { error } = await sb.from('answers').insert({ question_id:q.id, username:gameState.currentUser, answer, time_ms:timeTaken, is_correct:isCorrect });
      if(error){ console.warn('submitAnswer error', error); return; }
      if(isCorrect) confettiBurst();
      // Score is computed from DB; just refresh my number soon
      setTimeout(refreshAllLeaderboards, 200);
    }

    function disableAndHighlight(answer, correct){
      const buttons=[...document.querySelectorAll('#optionsContainer button')];
      buttons.forEach(b=>{ b.disabled=true; b.classList.add('opacity-50','cursor-not-allowed'); });
      buttons.forEach(btn=>{
        const key=btn.dataset.key;
        if(key===correct){ btn.classList.remove('from-amber-400','to-amber-600'); btn.classList.add('from-green-400','to-green-600'); }
        else if(key===answer&&answer!==correct){ btn.classList.remove('from-amber-400','to-amber-600'); btn.classList.add('from-red-400','to-red-600'); }
      });
    }

    // ===================== TIMER =====================
    function startOrSyncTimer(){
      clearInterval(gameState.questionTimer);
      const q=gameState.currentQuestion; if(!q) return;
      const circle=document.getElementById('timerCircle'); const text=document.getElementById('timerText');
      function tick(){
        const now=Date.now(); const remainingMs=q.endsAt-now; const remaining=Math.max(0,Math.ceil(remainingMs/1000));
        if(text) text.textContent=remaining;
        if(circle){ const elapsed=Math.min(q.timer,Math.max(0,Math.floor((now-q.startTime)/1000))); const progress=elapsed/q.timer; const offset=283-progress*283; circle.style.strokeDashoffset=offset; }
        if(remaining<=0){ clearInterval(gameState.questionTimer); endQuestion(); }
      }
      tick(); gameState.questionTimer=setInterval(tick,1000);
    }

    async function endQuestion(){
      clearInterval(gameState.questionTimer); gameState.questionTimer=null; gameState.currentQuestion=null;
      if(gameState.userType==='participant'){ document.getElementById('questionArea').classList.add('hidden'); document.getElementById('waitingArea').classList.remove('hidden'); }
      updateCurrentQuestionStatus(); updateFastestFinger(); refreshAllLeaderboards(); saveState();
    }

    // ===================== LIVE STATS & LEADERBOARDS =====================
    // Realtime updates: answers + adjustments + flags
    sb.channel('answers-live').on('postgres_changes', {event:'*',schema:'public',table:'answers'}, refreshAllLeaderboards).subscribe();
    sb.channel('adjustments-live').on('postgres_changes', {event:'*',schema:'public',table:'score_adjustments'}, refreshAllLeaderboards).subscribe();
    sb.channel('flags-live').on('postgres_changes', {event:'*',schema:'public',table:'participant_flags'}, refreshAllLeaderboards).subscribe();

    function pointsFromAnswer(r){ return r.is_correct ? (100 + Math.max(0, 50 - Math.floor(r.time_ms/1000))) : 0; }

    async function computeLeaderboard(){
      const users = Object.keys(credentials.participants);
      // answers
      const { data: answers, error:aErr } = await sb.from('answers').select('username,time_ms,is_correct');
      if(aErr){ console.warn(aErr); return []; }
      const base = {};
      answers.forEach(r=>{ if(!base[r.username]) base[r.username]=0; base[r.username]+=pointsFromAnswer(r); });
      // adjustments
      const { data: adj, error:adErr } = await sb.from('score_adjustments').select('username,delta');
      if(!adErr && adj){ adj.forEach(a=>{ if(!base[a.username]) base[a.username]=0; base[a.username]+= (a.delta||0); }); }
      // flags
      const { data: flags } = await sb.from('participant_flags').select('username,removed');
      const removedSet = new Set((flags||[]).filter(f=>f.removed).map(f=>f.username));

      // include all warriors; exclude removed
      users.forEach(u=>{ if(!base[u]) base[u]=0; });
      const rows = Object.entries(base).filter(([u,_])=>!removedSet.has(u)).map(([u,score])=>({
        name:u, score, avatar: gameState.participants[u]?.avatar || '⚔️', online: !!gameState.participants[u]?.online
      }));
      rows.sort((a,b)=> b.score - a.score);

      return rows;
    }

    async function refreshAllLeaderboards(){
      const rows = await computeLeaderboard();
      renderLeaderboard('loginLeaderboard', rows, true);
      renderLeaderboard('adminLeaderboard', rows, false);
      renderLeaderboard('participantLeaderboard', rows, false);

      // Update my score display
      if(gameState.userType==='participant' && gameState.currentUser){
        const me = rows.find(r=>r.name===gameState.currentUser);
        if(me) document.getElementById('participantScore').textContent = me.score;
      }
      populateAdminSelect();
    }

    function renderLeaderboard(containerId, rows, small){
      const el = document.getElementById(containerId); if(!el) return;
      const prev = gameState.prevRanks || {};
      const mapRank = {}; rows.forEach((r,i)=> mapRank[r.name]=i+1);
      el.innerHTML = rows.map((p,i)=>{
        const medal = i===0?'🥇':i===1?'🥈':i===2?'🥉':'🏅';
        const status = p.online ? '<span class="text-green-600">Online</span>' : '<span class="text-gray-400">Offline</span>';
        const me = p.name===gameState.currentUser && gameState.userType==='participant';
        const hl = me ? 'ring-2 ring-blue-500 bg-blue-50' : 'bg-gradient-to-r from-amber-50 to-orange-50';
        const jump = (prev[p.name] && prev[p.name] > (i+1)) ? 'rank-jump' : '';
        const pad = small ? 'p-3' : 'p-4';
        return `<div class="flex items-center justify-between ${pad} ${hl} ${jump} rounded-xl border border-amber-200">
          <div class="flex items-center space-x-4">
            <span class="text-2xl">${medal}</span>
            <span class="text-2xl">${p.avatar}</span>
            <div>
              <div class="font-bold text-gray-800">${p.name} ${me?'(You)':''}</div>
              <div class="text-sm text-gray-600">Rank #${i+1} • ${status}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-amber-600">${p.score}</div>
            <div class="text-sm text-gray-600">points</div>
          </div>
        </div>`;
      }).join('');
      gameState.prevRanks = mapRank; saveState();
    }

    async function updateFastestFinger(){
      const el = document.getElementById('fastestFinger'); if(!el) return;
      const q = gameState.currentQuestion; if(!q){ el.textContent='Waiting for answers...'; return; }
      const { data, error } = await sb.from('answers').select('username,time_ms,is_correct').eq('question_id', q.id);
      if(error){ console.error('fastest error', error); el.textContent='Waiting for answers...'; return; }
      const correct = (data||[]).filter(r=>r.is_correct);
      if(!correct.length){ el.textContent='No correct answers yet...'; return; }
      correct.sort((a,b)=>a.time_ms-b.time_ms); const f=correct[0];
      const avatar=gameState.participants[f.username]?.avatar||'⚡';
      el.innerHTML = `${avatar} ${f.username} (${(f.time_ms/1000).toFixed(1)}s)`;
      const statusEl=document.getElementById('currentQuestionStatus'); if(statusEl) statusEl.textContent=`Active - ${(data||[]).length} warriors answered`;
    }

    function updateActiveParticipants(){
      const count = Object.values(gameState.participants).filter(p=>p.online).length;
      const el = document.getElementById('activeParticipants'); if(el) el.textContent = `${count} / 8 warriors online`;
    }
    function updateCurrentQuestionStatus(){
      const el=document.getElementById('currentQuestionStatus'); if(!el) return;
      el.textContent = gameState.currentQuestion ? 'Active - gathering answers...' : 'No active question';
    }

    // ===================== ADMIN ADJUSTMENTS & REMOVE =====================
    async function adminAddPoints(){
      const user = document.getElementById('adminSelectUser').value;
      const delta = parseInt(document.getElementById('adminDelta').value||'0',10);
      const reason = document.getElementById('adminReason').value.trim() || 'Manual adjustment';
      if(!user || !delta){ msg('Please choose a user and enter non-zero points.'); return; }
      const { error } = await sb.from('score_adjustments').insert({ username:user, delta, reason });
      if(error){ msg('Failed to add points: '+error.message, true); return; }
      msg(`Adjusted ${user} by ${delta} points (${reason}).`);
      document.getElementById('adminDelta').value=''; document.getElementById('adminReason').value='';
      refreshAllLeaderboards();
    }

    async function adminRemoveParticipant(removed){
      const user = document.getElementById('adminSelectUser').value;
      if(!user){ msg('Pick a user first.'); return; }
      // upsert into flags
      const { error } = await sb.from('participant_flags').upsert({ username:user, removed }, { onConflict: 'username' });
      if(error){ msg('Failed: '+error.message, true); return; }
      msg(`${removed?'Removed':'Restored'} ${user}.`);
      // also flip local online state
      if(gameState.participants[user]) gameState.participants[user].online = !removed;
      updateActiveParticipants(); refreshAllLeaderboards();
    }

    function populateAdminSelect(){
      const sel = document.getElementById('adminSelectUser'); if(!sel) return;
      const users = Object.keys(credentials.participants);
      sel.innerHTML = users.map(u=>`<option value="${u}">${u}</option>`).join('');
    }
    function msg(text, bad=false){ const el=document.getElementById('adminActionMsg'); if(!el) return; el.textContent=text; el.className = 'text-sm ' + (bad?'text-red-600':'text-gray-600'); }

    // ===================== BOOT =====================
    (async function boot(){
      loadState(); initializeParticipants(); populateAdminSelect();
      if(gameState.userType){ showDashboard(gameState.userType); if(gameState.userType==='participant' && gameState.currentUser){ document.getElementById('participantName').textContent=gameState.currentUser; document.getElementById('participantAvatar').textContent=gameState.participants[gameState.currentUser]?.avatar||'⚔️'; } }
      fetchActiveQuestion(); updateActiveParticipants(); updateCurrentQuestionStatus();
      refreshAllLeaderboards();
      window.addEventListener('beforeunload', saveState);
    })();
  </script>
</body>
</html>

