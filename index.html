<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warrior Quiz Arena - Ancient Indian Battle (Fixed)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .warrior-bg { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%); }
    .ancient-pattern { background-image:
      radial-gradient(circle at 25% 25%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 75% 75%, rgba(255, 69, 0, 0.1) 0%, transparent 50%);
    }
    .weapon-shadow { filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3)); }
    .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
  </style>
</head>
<body class="warrior-bg ancient-pattern min-h-screen">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gradient-to-br from-amber-100 to-orange-100 rounded-3xl shadow-2xl p-8 max-w-md w-full border-4 border-amber-600">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">‚öîÔ∏è</div>
        <h1 class="text-3xl font-bold text-amber-900 mb-2">Warrior Quiz Arena</h1>
        <p class="text-amber-700">Enter the Ancient Battle</p>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-amber-800 font-semibold mb-2">Username</label>
          <input type="text" id="username" class="w-full px-4 py-3 rounded-xl border-2 border-amber-300 focus:border-amber-600 focus:outline-none" placeholder="Enter username" />
        </div>

        <div>
          <label class="block text-amber-800 font-semibold mb-2">Password</label>
          <input type="password" id="password" class="w-full px-4 py-3 rounded-xl border-2 border-amber-300 focus:border-amber-600 focus:outline-none" placeholder="Enter password" />
        </div>

        <div class="flex space-x-4">
          <button onclick="login('admin')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">üõ°Ô∏è Admin</button>
          <button onclick="login('participant')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">‚öîÔ∏è Warrior</button>
        </div>
      </div>

      <div class="mt-6 text-sm text-amber-700 bg-amber-50 p-4 rounded-xl">
        <p><strong>Admin:</strong> admin / admin123</p>
        <p><strong>Warriors:</strong> warrior1-8 / battle123</p>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="hidden min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
      <div class="bg-gradient-to-r from-red-800 to-red-600 rounded-2xl p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-bold flex items-center">üõ°Ô∏è Admin Command Center</h1>
            <p class="text-red-200">Control the Ancient Battle Arena</p>
          </div>
          <button onclick="logout()" class="bg-red-900 hover:bg-red-800 px-4 py-2 rounded-lg transition-colors">Logout</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Question Management -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">üìú Question Scroll</h2>

          <div class="space-y-4">
            <input type="text" id="adminQuestionText" placeholder="Enter your battle question..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-amber-500 focus:outline-none" />

            <div class="grid grid-cols-2 gap-2">
              <input type="text" id="adminOptionA" placeholder="Option A" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none" />
              <input type="text" id="adminOptionB" placeholder="Option B" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none" />
              <input type="text" id="adminOptionC" placeholder="Option C" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none" />
              <input type="text" id="adminOptionD" placeholder="Option D" class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none" />
            </div>

            <div class="flex space-x-4">
              <select id="adminCorrectAnswer" class="flex-1 px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none">
                <option value="">Select Correct Answer</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>

              <input type="number" id="adminQuestionTimer" placeholder="Timer (sec)" min="10" max="120" value="30" class="w-24 px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-amber-500 focus:outline-none" />
            </div>

            <button onclick="postQuestion()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">üèπ Launch Question</button>
          </div>
        </div>

        <!-- Live Stats -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">‚ö° Battle Statistics</h2>

          <div class="space-y-4">
            <div class="bg-green-50 p-4 rounded-xl">
              <h3 class="font-bold text-green-800 mb-2">‚ö° Fastest Finger</h3>
              <div id="fastestFinger" class="text-green-600">Waiting for answers...</div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl">
              <h3 class="font-bold text-blue-800 mb-2">üë• Active Warriors</h3>
              <div id="activeParticipants" class="text-blue-600">0 / 8 warriors online</div>
            </div>

            <div class="bg-purple-50 p-4 rounded-xl">
              <h3 class="font-bold text-purple-800 mb-2">üìä Current Question</h3>
              <div id="currentQuestionStatus" class="text-purple-600">No active question</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Leaderboard -->
      <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">üèÜ Warrior Leaderboard</h2>
        <div id="adminLeaderboard" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Participant Dashboard -->
  <div id="participantDashboard" class="hidden min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <div class="bg-gradient-to-r from-blue-800 to-blue-600 rounded-2xl p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-4">
            <div id="participantAvatar" class="text-4xl"></div>
            <div>
              <h1 class="text-2xl font-bold" id="participantName">Warrior</h1>
              <p class="text-blue-200">Ready for Battle</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-3xl font-bold" id="participantScore">0</div>
            <div class="text-blue-200">Points</div>
            <button onclick="logout()" class="mt-2 bg-blue-900 hover:bg-blue-800 px-4 py-2 rounded-lg transition-colors">Logout</button>
          </div>
        </div>
      </div>

      <!-- Question Area -->
      <div id="questionArea" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Battle Question</h2>
          <div class="relative w-16 h-16">
            <svg class="w-16 h-16 transform -rotate-90">
              <circle cx="32" cy="32" r="28" stroke="#e5e7eb" stroke-width="4" fill="none"></circle>
              <circle id="timerCircle" cx="32" cy="32" r="28" stroke="#f59e0b" stroke-width="4" fill="none" class="timer-ring"></circle>
            </svg>
            <div id="timerText" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-amber-600">30</div>
          </div>
        </div>

        <div id="participantQuestionText" class="text-xl text-gray-800 mb-6 p-4 bg-amber-50 rounded-xl border-l-4 border-amber-500">Waiting for question...</div>

        <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- Waiting Area -->
      <div id="waitingArea" class="bg-white rounded-2xl shadow-xl p-8 text-center">
        <div class="text-6xl mb-4 animate-bounce">‚öîÔ∏è</div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Preparing for Battle</h2>
        <p class="text-gray-600">Waiting for the next question from the battle master...</p>
      </div>

      <!-- Participant Leaderboard -->
      <div class="mt-6 bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">üèÜ Warrior Rankings</h2>
        <div id="participantLeaderboard" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    // ======= PERSISTENCE (fix refresh logout + cross-tab sync) =======
    const STORAGE_KEY = 'warriorQuizState_v2'; // versioned to avoid old collisions
    const QUESTION_KEY = 'warriorQuizCurrentQuestion_v2';

    function saveState() {
      const stateToSave = {
        participants: gameState.participants,
        leaderboard: gameState.leaderboard,
        currentUser: gameState.currentUser,
        userType: gameState.userType
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const saved = JSON.parse(raw);
        if (saved.participants) gameState.participants = saved.participants;
        if (Array.isArray(saved.leaderboard)) gameState.leaderboard = saved.leaderboard;
        if (saved.currentUser) gameState.currentUser = saved.currentUser;
        if (saved.userType) gameState.userType = saved.userType;
      } catch (e) { console.warn('Failed to parse saved state', e); }
    }

    function saveQuestionToStorage(q) {
      localStorage.setItem(QUESTION_KEY, JSON.stringify(q));
    }

    function getQuestionFromStorage() {
      const raw = localStorage.getItem(QUESTION_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    // ======= Game State =======
    let gameState = {
      currentUser: null,
      userType: null,
      participants: {},
      currentQuestion: null,
      questionTimer: null,
      questionStartTime: null,
      leaderboard: []
    };

    // Warrior Avatars
    const warriorAvatars = ['üèπ', '‚öîÔ∏è', 'üõ°Ô∏è', 'üó°Ô∏è', 'üè∫', 'üéØ', '‚ö°', 'üî•'];

    // Built-in credentials
    const credentials = {
      admin: { username: 'admin', password: 'admin123' },
      participants: {
        warrior1: 'battle123', warrior2: 'battle123', warrior3: 'battle123', warrior4: 'battle123',
        warrior5: 'battle123', warrior6: 'battle123', warrior7: 'battle123', warrior8: 'battle123'
      }
    };

    // Initialize participants if needed
    function initializeParticipants() {
      if (Object.keys(gameState.participants).length > 0) { updateLeaderboard(); return; }
      Object.keys(credentials.participants).forEach((username, index) => {
        gameState.participants[username] = {
          name: username,
          avatar: warriorAvatars[index],
          score: 0,
          online: false,
          lastAnswerTime: null
        };
      });
      updateLeaderboard();
    }

    // ======= Auth =======
    function login(type) {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) { alert('Please enter both username and password!'); return; }

      let isValid = false;
      if (type === 'admin') {
        isValid = username === credentials.admin.username && password === credentials.admin.password;
      } else {
        isValid = credentials.participants[username] === password;
      }

      if (!isValid) { alert('Invalid credentials! Please check the login guide.'); return; }

      gameState.currentUser = username;
      gameState.userType = type;

      if (type === 'participant') {
        if (!gameState.participants[username]) {
          // Safety: create if not existing (in case state was wiped)
          gameState.participants[username] = {
            name: username, avatar: '‚öîÔ∏è', score: 0, online: true, lastAnswerTime: null
          };
        }
        gameState.participants[username].online = true;
        document.getElementById('participantName').textContent = username;
        document.getElementById('participantAvatar').textContent = gameState.participants[username].avatar;
        document.getElementById('participantScore').textContent = gameState.participants[username].score;
      }

      showDashboard(type);
      updateActiveParticipants();
      updateLeaderboard();
      saveState();

      // If there's an active question, show it immediately to the participant
      if (type === 'participant') {
        const q = getQuestionFromStorage();
        if (q && Date.now() < q.endsAt) {
          gameState.currentQuestion = q;
          gameState.questionStartTime = q.startTime;
          displayQuestionToParticipants();
          startOrSyncTimer();
        }
      }
    }

    function showDashboard(type) {
      document.getElementById('loginScreen').classList.add('hidden');
      if (type === 'admin') {
        document.getElementById('adminDashboard').classList.remove('hidden');
      } else {
        document.getElementById('participantDashboard').classList.remove('hidden');
      }
    }

    function logout() {
      if (gameState.userType === 'participant' && gameState.currentUser) {
        gameState.participants[gameState.currentUser].online = false;
      }
      const wasUser = gameState.currentUser;

      gameState.currentUser = null;
      gameState.userType = null;

      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('participantDashboard').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');

      // Clear form
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';

      updateActiveParticipants();
      updateLeaderboard();
      saveState();

      // Optional: keep them logged out across refreshes explicitly
      if (wasUser) {
        // nothing else to do; state already saved
      }
    }

    // ======= Admin: Post Question (broadcast via localStorage) =======
    function postQuestion() {
      const questionText = document.getElementById('adminQuestionText').value.trim();
      const optionA = document.getElementById('adminOptionA').value.trim();
      const optionB = document.getElementById('adminOptionB').value.trim();
      const optionC = document.getElementById('adminOptionC').value.trim();
      const optionD = document.getElementById('adminOptionD').value.trim();
      const correctAnswer = document.getElementById('adminCorrectAnswer').value;
      const timer = parseInt(document.getElementById('adminQuestionTimer').value) || 30;

      if (!questionText || !optionA || !optionB || !optionC || !optionD || !correctAnswer) {
        alert('Please fill in all fields!');
        return;
      }

      const startTime = Date.now();
      const endsAt = startTime + timer * 1000;

      const newQuestion = {
        id: `${startTime}`,
        text: questionText,
        options: { A: optionA, B: optionB, C: optionC, D: optionD },
        correct: correctAnswer,
        timer: timer,
        startTime: startTime,
        endsAt: endsAt,
        answers: {}
      };

      gameState.currentQuestion = newQuestion;
      gameState.questionStartTime = startTime;

      // Clear admin form
      document.getElementById('adminQuestionText').value = '';
      document.getElementById('adminOptionA').value = '';
      document.getElementById('adminOptionB').value = '';
      document.getElementById('adminOptionC').value = '';
      document.getElementById('adminOptionD').value = '';
      document.getElementById('adminCorrectAnswer').value = '';

      // Broadcast to all participants via localStorage
      saveQuestionToStorage(newQuestion);
      updateCurrentQuestionStatus();
      startOrSyncTimer();
    }

    // ======= Participant: Display & Answer =======
    function displayQuestionToParticipants() {
      const qa = document.getElementById('questionArea');
      const wa = document.getElementById('waitingArea');
      if (!gameState.currentQuestion) { qa.classList.add('hidden'); wa.classList.remove('hidden'); return; }

      wa.classList.add('hidden');
      qa.classList.remove('hidden');

      document.getElementById('participantQuestionText').textContent = gameState.currentQuestion.text;

      const optionsContainer = document.getElementById('optionsContainer');
      optionsContainer.innerHTML = '';

      Object.entries(gameState.currentQuestion.options).forEach(([key, value]) => {
        const button = document.createElement('button');
        button.className = 'bg-gradient-to-r from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 text-left';
        button.innerHTML = `<span class="text-xl font-bold">${key}.</span> ${value}`;
        button.onclick = () => submitAnswer(key);
        optionsContainer.appendChild(button);
      });
    }

    function submitAnswer(answer) {
      if (!gameState.currentQuestion || !gameState.currentUser) return;

      const user = gameState.currentUser;
      const now = Date.now();

      // Pull latest question from storage to prevent overwriting concurrent answers
      const q = getQuestionFromStorage();
      if (!q || now >= q.endsAt) return;
      if (q.answers[user]) return; // already answered

      const timeTaken = now - q.startTime;
      q.answers[user] = { answer, time: timeTaken, timestamp: now };

      // Scoring
      let points = 0;
      if (answer === q.correct) {
        points = 100 + Math.max(0, 50 - Math.floor(timeTaken / 1000));
      }
      if (gameState.participants[user]) {
        gameState.participants[user].score = (gameState.participants[user].score || 0) + points;
        gameState.participants[user].lastAnswerTime = timeTaken;
        document.getElementById('participantScore').textContent = gameState.participants[user].score;
      }

      // Disable options & highlight
      const buttons = document.querySelectorAll('#optionsContainer button');
      buttons.forEach((btn) => { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); });
      buttons.forEach((btn, index) => {
        const optionKey = ['A', 'B', 'C', 'D'][index];
        if (optionKey === q.correct) {
          btn.classList.remove('from-amber-400', 'to-amber-600');
          btn.classList.add('from-green-400', 'to-green-600');
        } else if (optionKey === answer && answer !== q.correct) {
          btn.classList.remove('from-amber-400', 'to-amber-600');
          btn.classList.add('from-red-400', 'to-red-600');
        }
      });

      // Persist updated question & state so admin sees answers live
      saveQuestionToStorage(q);
      gameState.currentQuestion = q;
      updateFastestFinger();
      updateLeaderboard();
      saveState();
    }

    // ======= Timer Handling =======
    function startOrSyncTimer() {
      clearInterval(gameState.questionTimer);
      const q = gameState.currentQuestion || getQuestionFromStorage();
      if (!q) return;

      const timerCircle = document.getElementById('timerCircle');
      const timerText = document.getElementById('timerText');

      function tick() {
        const now = Date.now();
        const remainingMs = q.endsAt - now;
        const remaining = Math.max(0, Math.ceil(remainingMs / 1000));
        if (timerText) timerText.textContent = remaining;
        if (timerCircle) {
          const duration = q.timer;
          const elapsed = Math.min(duration, Math.max(0, Math.floor((now - q.startTime) / 1000)));
          const progress = elapsed / duration;
          const offset = 283 - progress * 283;
          timerCircle.style.strokeDashoffset = offset;
        }
        if (remaining <= 0) { clearInterval(gameState.questionTimer); endQuestion(); }
      }

      tick();
      gameState.questionTimer = setInterval(tick, 1000);
    }

    function endQuestion() {
      gameState.currentQuestion = null;
      // Don't immediately wipe from storage so admin can still see answers count; but mark ended
      const q = getQuestionFromStorage();
      if (q) { q.ended = true; saveQuestionToStorage(q); }

      if (gameState.userType === 'participant') {
        document.getElementById('questionArea').classList.add('hidden');
        document.getElementById('waitingArea').classList.remove('hidden');
      }

      updateCurrentQuestionStatus();
      updateFastestFinger();
      updateLeaderboard();
      saveState();
    }

    // ======= Live Stats =======
    function updateFastestFinger() {
      const fastestEl = document.getElementById('fastestFinger');
      const q = getQuestionFromStorage();
      if (!fastestEl) return;
      if (!q || !q.answers || Object.keys(q.answers).length === 0) {
        fastestEl.textContent = 'Waiting for answers...';
        return;
      }
      let fastest = null; let fastestTime = Infinity;
      Object.entries(q.answers).forEach(([user, data]) => {
        if (data.answer === q.correct && data.time < fastestTime) {
          fastest = user; fastestTime = data.time;
        }
      });
      if (fastest) {
        const avatar = gameState.participants[fastest]?.avatar || '‚ö°';
        fastestEl.innerHTML = `${avatar} ${fastest} (${(fastestTime / 1000).toFixed(1)}s)`;
      } else {
        fastestEl.textContent = 'No correct answers yet...';
      }
    }

    function updateActiveParticipants() {
      const count = Object.values(gameState.participants).filter((p) => p.online).length;
      const el = document.getElementById('activeParticipants');
      if (el) el.textContent = `${count} / 8 warriors online`;
    }

    function updateCurrentQuestionStatus() {
      const el = document.getElementById('currentQuestionStatus');
      if (!el) return;
      const q = getQuestionFromStorage();
      if (q && Date.now() < q.endsAt) {
        const answeredCount = Object.keys(q.answers || {}).length;
        el.textContent = `Active - ${answeredCount} warriors answered`;
      } else {
        el.textContent = 'No active question';
      }
    }

    function updateLeaderboard() {
      const sorted = Object.values(gameState.participants).sort((a, b) => b.score - a.score);

      const adminBoard = document.getElementById('adminLeaderboard');
      if (adminBoard) {
        adminBoard.innerHTML = sorted.map((p, i) => {
          const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ';
          const statusColor = p.online ? 'text-green-600' : 'text-gray-400';
          const status = p.online ? 'Online' : 'Offline';
          return `
            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
              <div class="flex items-center space-x-4">
                <span class="text-2xl">${medal}</span>
                <span class="text-2xl">${p.avatar}</span>
                <div>
                  <div class="font-bold text-gray-800">${p.name}</div>
                  <div class="text-sm ${statusColor}">${status}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-amber-600">${p.score}</div>
                <div class="text-sm text-gray-600">points</div>
              </div>
            </div>`;
        }).join('');
      }

      const participantBoard = document.getElementById('participantLeaderboard');
      if (participantBoard) {
        participantBoard.innerHTML = sorted.map((p, i) => {
          const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ';
          const isMe = p.name === gameState.currentUser;
          const highlight = isMe ? 'ring-2 ring-blue-500 bg-blue-50' : 'bg-gray-50';
          return `
            <div class="flex items-center justify-between p-4 ${highlight} rounded-xl border border-gray-200">
              <div class="flex items-center space-x-4">
                <span class="text-2xl">${medal}</span>
                <span class="text-2xl">${p.avatar}</span>
                <div>
                  <div class="font-bold text-gray-800">${p.name} ${isMe ? '(You)' : ''}</div>
                  <div class="text-sm text-gray-600">Rank #${i + 1}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-amber-600">${p.score}</div>
                <div class="text-sm text-gray-600">points</div>
              </div>
            </div>`;
        }).join('');
      }
    }

    // ======= Cross-tab listener: pick up admin posts in participants immediately =======
    window.addEventListener('storage', (e) => {
      if (e.key === QUESTION_KEY) {
        const q = getQuestionFromStorage();
        if (q && Date.now() < q.endsAt) {
          gameState.currentQuestion = q;
          gameState.questionStartTime = q.startTime;
          if (gameState.userType === 'participant') {
            displayQuestionToParticipants();
            startOrSyncTimer();
          }
          updateCurrentQuestionStatus();
          updateFastestFinger();
        } else {
          endQuestion();
        }
      } else if (e.key === STORAGE_KEY) {
        loadState();
        updateActiveParticipants();
        updateLeaderboard();
      }
    });

    // ======= Boot =======
    (function boot() {
      loadState();
      initializeParticipants();

      // If user had a session, restore the correct dashboard
      if (gameState.userType) {
        showDashboard(gameState.userType);
        if (gameState.userType === 'participant' && gameState.currentUser) {
          document.getElementById('participantName').textContent = gameState.currentUser;
          document.getElementById('participantAvatar').textContent = gameState.participants[gameState.currentUser]?.avatar || '‚öîÔ∏è';
          document.getElementById('participantScore').textContent = gameState.participants[gameState.currentUser]?.score || 0;
        }
      }

      // If a question is active, sync it
      const q = getQuestionFromStorage();
      if (q && Date.now() < q.endsAt) {
        gameState.currentQuestion = q;
        gameState.questionStartTime = q.startTime;
        if (gameState.userType === 'participant') {
          displayQuestionToParticipants();
        }
        startOrSyncTimer();
      }

      updateActiveParticipants();
      updateLeaderboard();
      updateCurrentQuestionStatus();

      // Persist on unload
      window.addEventListener('beforeunload', saveState);
    })();
  </script>
</body>
</html>

